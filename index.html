<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TALKO System - –¢–∞—Å–∫ –ú–µ–Ω–µ–¥–∂–µ—Ä Pro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; color: #2c3e50; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem 2rem; box-shadow: 0 2px 20px rgba(0,0,0,0.1); }
        .header-content { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 1.5rem; font-weight: 700; }
        .lang-switch { display: flex; gap: 0.5rem; }
        .lang-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 5px; cursor: pointer; transition: all 0.3s; }
        .lang-btn.active { background: rgba(255,255,255,0.3); font-weight: 600; }
        .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
        .controls { background: white; padding: 1.5rem; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 2rem; display: flex; gap: 1rem; flex-wrap: wrap; align-items: center; }
        .btn { background: #3498db; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 5px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; font-weight: 500; }
        .btn:hover { background: #2980b9; transform: translateY(-1px); }
        .btn-success { background: #27ae60; } .btn-success:hover { background: #229954; }
        .btn-danger { background: #e74c3c; } .btn-danger:hover { background: #c0392b; }
        .btn-clear { background: #95a5a6; color: white; } .btn-clear:hover { background: #7f8c8d; }
        .btn-small { padding: 0.25rem 0.5rem; font-size: 0.75rem; border-radius: 3px; }
        .filters { display: flex; gap: 0.5rem; margin-left: auto; flex-wrap: wrap; }
        .filter-select { padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px; background: white; font-size: 0.8rem; }
        .tab-navigation { display: flex; background: white; border-radius: 10px 10px 0 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 0; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; }
        .tab-navigation::-webkit-scrollbar { display: none; }
        .tab-btn { background: transparent; border: none; padding: 1rem 1.2rem; cursor: pointer; font-size: 0.85rem; font-weight: 500; color: #7f8c8d; transition: all 0.3s; border-bottom: 3px solid transparent; white-space: nowrap; min-width: fit-content; }
        .tab-btn:hover { color: #2c3e50; background: rgba(52, 73, 94, 0.05); }
        .tab-btn.active { color: #3498db; border-bottom-color: #3498db; font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tasks-grid, .functions-grid, .control-dashboard, .analytics-container { background: white; border-radius: 0 0 10px 10px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .task-header { background: #34495e; color: white; padding: 1rem; display: grid; grid-template-columns: 3fr 1.2fr 1.2fr 1fr 0.8fr 0.8fr 1fr; gap: 0.5rem; font-weight: 600; font-size: 0.85rem; }
        .task-row { padding: 0.75rem; display: grid; grid-template-columns: 3fr 1.2fr 1.2fr 1fr 0.8fr 0.8fr 1fr; gap: 0.5rem; border-bottom: 1px solid #ecf0f1; align-items: center; transition: all 0.3s; font-size: 0.85rem; }
        .task-row:hover { background: #f8f9fa; }
        .task-row.pinned { background: linear-gradient(90deg, rgba(52, 152, 219, 0.1) 0%, rgba(255, 255, 255, 1) 100%); border-left: 4px solid #3498db; }
        .task-title { font-weight: 600; color: #2c3e50; font-size: 0.9rem; }
        .task-info { font-size: 0.75rem; color: #7f8c8d; margin-top: 0.25rem; }
        .task-title-container { display: flex; align-items: center; gap: 0.5rem; }
        .pin-btn { background: none; border: none; cursor: pointer; font-size: 1rem; color: #bdc3c7; transition: all 0.3s; padding: 0.2rem; }
        .pin-btn:hover { color: #f39c12; transform: scale(1.1); }
        .pin-btn.pinned { color: #f39c12; }
        .status-badge, .type-badge { padding: 0.2rem 0.5rem; border-radius: 10px; font-size: 0.7rem; font-weight: 500; text-align: center; }
        .status-new { background: #e3f2fd; color: #1976d2; }
        .status-progress { background: #fff3e0; color: #f57c00; }
        .status-review { background: #fce4ec; color: #c2185b; }
        .status-done { background: #e8f5e8; color: #388e3c; }
        .type-single { background: #e3f2fd; color: #1976d2; }
        .type-regular { background: #f3e5f5; color: #7b1fa2; }
        .type-bottleneck { background: #ffebee; color: #d32f2f; }
        .empty-state { text-align: center; padding: 3rem 2rem; color: #7f8c8d; }
        .empty-state h3 { margin-bottom: 1rem; color: #34495e; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 2% auto; padding: 0; border-radius: 10px; width: 90%; max-width: 700px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { background: #34495e; color: white; padding: 1.5rem; border-radius: 10px 10px 0 0; }
        .modal-body { padding: 1.5rem; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-group { display: flex; flex-direction: column; }
        .form-group.full-width { grid-column: span 2; }
        .form-label { margin-bottom: 0.5rem; font-weight: 600; color: #34495e; font-size: 0.9rem; }
        .form-input, .form-select, .form-textarea { padding: 0.6rem; border: 2px solid #ecf0f1; border-radius: 5px; font-size: 0.9rem; transition: border-color 0.3s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #3498db; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .close { color: #aaa; float: right; font-size: 24px; font-weight: bold; cursor: pointer; margin-top: -5px; }
        .close:hover { color: white; }
        .functions-grid { padding: 1.5rem; }
        .function-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }
        .function-card { background: #f8f9fa; border: 2px solid #ecf0f1; border-radius: 10px; padding: 1.2rem; transition: all 0.3s; }
        .function-card:hover { border-color: #3498db; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .function-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem; }
        .function-description { color: #7f8c8d; margin-bottom: 1rem; line-height: 1.4; font-size: 0.85rem; }
        .function-assignees { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 1rem; }
        .assignee-badge { background: #27ae60; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; }
        .function-tasks-count { color: #3498db; font-weight: 600; font-size: 0.85rem; }
        .control-dashboard, .analytics-container { padding: 1.5rem; }
        .control-overview, .analytics-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        .control-card, .analytics-card { border-radius: 12px; padding: 1.5rem; text-align: center; box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
        .control-card.urgent { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%); color: white; }
        .control-card.warning { background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%); color: white; }
        .control-card.active { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; }
        .control-card.completed { background: linear-gradient(135deg, #55efc4 0%, #00b894 100%); color: white; }
        .analytics-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .control-number, .analytics-number { font-size: 2rem; font-weight: 700; margin: 0.5rem 0; }
        .control-filters { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; align-items: center; background: #f8f9fa; padding: 1rem; border-radius: 8px; }
        .chart-container { background: #f8f9fa; border-radius: 8px; padding: 1rem; min-height: 200px; margin-bottom: 1rem; }
        .chart-container h3 { color: #2c3e50; font-size: 1rem; margin-bottom: 0.8rem; }
        .regular-tasks-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; padding: 1rem; }
        .regular-task-card { background: white; border: 2px solid #ecf0f1; border-radius: 12px; padding: 1.2rem; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .regular-task-card:hover { border-color: #3498db; transform: translateY(-1px); }
        .regular-task-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.8rem; }
        .regular-task-title { font-size: 1rem; font-weight: 600; color: #2c3e50; flex: 1; }
        .regular-task-info { background: #f8f9fa; border-radius: 8px; padding: 0.8rem; margin-bottom: 0.8rem; font-size: 0.8rem; line-height: 1.4; }
        .regular-task-info div { margin-bottom: 0.3rem; }
        .regular-task-info strong { color: #34495e; font-weight: 600; }
        .regular-task-actions { display: flex; gap: 0.5rem; justify-content: flex-end; }
        #dateRangeInputs { display: none; align-items: center; gap: 0.3rem; }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .task-header, .task-row { grid-template-columns: 1fr; gap: 0.3rem; }
            .task-header > div, .task-row > div { padding: 0.3rem 0; border-bottom: 1px solid #ecf0f1; }
            .form-grid { grid-template-columns: 1fr; }
            .form-group.full-width { grid-column: span 1; }
            .filters { margin-left: 0; justify-content: flex-start; }
            .controls { flex-direction: column; align-items: stretch; }
            .tab-btn { padding: 0.8rem 1rem; }
        }

        /* üîê –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø */
        .auth-container { display: flex; justify-content: center; align-items: center; min-height: calc(100vh - 200px); padding: 2rem; }
        .auth-card { background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); padding: 0; max-width: 400px; width: 100%; overflow: hidden; }
        .auth-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; text-align: center; }
        .auth-header h2 { margin-bottom: 0.5rem; font-size: 1.8rem; }
        .auth-header p { opacity: 0.9; font-size: 0.9rem; }
        .auth-body { padding: 2rem; }
        .auth-form h3 { margin-bottom: 1.5rem; color: #2c3e50; text-align: center; }
        .main-interface { display: none; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">TALKO System - –¢–∞—Å–∫ –ú–µ–Ω–µ–¥–∂–µ—Ä Pro</div>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div id="currentUserInfo" style="background: rgba(255,255,255,0.2); padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.9rem; cursor: pointer;" onclick="switchUserForTesting()">
                    üë§ <span id="currentUserName">–û–ª–µ–∫—Å–∞–Ω–¥—Ä –¢–∞–ª—å–∫–æ</span> 
                    <span id="currentUserRole" style="font-size: 0.8rem; opacity: 0.8;">(–í–ª–∞—Å–Ω–∏–∫)</span>
                    <span style="font-size: 0.7rem; opacity: 0.7;">‚Üª</span>
                </div>
                <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-size: 0.9rem; margin-left: 0.5rem;">
                    üö™ –í–∏–π—Ç–∏
                </button>
                <div class="lang-switch">
                    <button class="lang-btn active" onclick="setLanguage('ua')">UA</button>
                    <button class="lang-btn" onclick="setLanguage('ru')">RU</button>
                    <button class="lang-btn" onclick="setLanguage('bg')">BG</button>
                    <button class="lang-btn" onclick="setLanguage('en')">EN</button>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- üîê –°–¢–û–†–Ü–ù–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–Ü–á -->
        <div id="authPage" class="auth-container" style="display: none;">
            <div class="auth-card">
                <div class="auth-header">
                    <h2>üöÄ TALKO System</h2>
                    <p>–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è–º–∏</p>
                </div>
                <div class="auth-body">
                    <div id="loginForm" class="auth-form">
                        <h3>–í—Ö—ñ–¥ –¥–æ —Å–∏—Å—Ç–µ–º–∏</h3>
                        <div class="form-group">
                            <label>Email:</label>
                            <input type="email" id="loginEmail" class="form-input" placeholder="your@email.com" required>
                        </div>
                        <button onclick="sendLoginCode()" class="btn btn-success" style="width: 100%; margin-top: 1rem;">
                            üìß –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∫–æ–¥
                        </button>
                        <div style="text-align: center; margin-top: 1rem;">
                            <small style="color: #7f8c8d;">–ú–∏ –≤—ñ–¥–ø—Ä–∞–≤–∏–º–æ –∫–æ–¥ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –Ω–∞ –≤–∞—à email</small>
                        </div>
                    </div>
                    
                    <div id="codeForm" class="auth-form" style="display: none;">
                        <h3>–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è</h3>
                        <div class="form-group">
                            <label>–ö–æ–¥ –∑ email:</label>
                            <input type="text" id="loginCode" class="form-input" placeholder="123456" maxlength="6" required>
                        </div>
                        <button onclick="verifyLoginCode()" class="btn btn-success" style="width: 100%; margin-top: 1rem;">
                            ‚úÖ –£–≤—ñ–π—Ç–∏
                        </button>
                        <button onclick="backToLogin()" class="btn" style="width: 100%; margin-top: 0.5rem;">
                            ‚Üê –ù–∞–∑–∞–¥
                        </button>
                    </div>
                    
                    <div id="inviteForm" class="auth-form" style="display: none;">
                        <h3>–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –∑–∞ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è–º</h3>
                        <div class="form-group">
                            <label>–Ü–º'—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ:</label>
                            <input type="text" id="inviteName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label>–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                            <input type="tel" id="invitePhone" class="form-input">
                        </div>
                        <button onclick="completeRegistration()" class="btn btn-success" style="width: 100%; margin-top: 1rem;">
                            üéâ –ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- üì± –û–°–ù–û–í–ù–ò–ô –Ü–ù–¢–ï–†–§–ï–ô–° -->
        <div id="mainInterface" class="main-interface">
            <div class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('tasks')">–ó–∞–≤–¥–∞–Ω–Ω—è</button>
            <button class="tab-btn" onclick="switchTab('control')">–ö–æ–Ω—Ç—Ä–æ–ª—å</button>
            <button class="tab-btn" onclick="switchTab('regular')">–†–µ–≥—É–ª—è—Ä–Ω—ñ</button>
            <button class="tab-btn" onclick="switchTab('functions')">–§—É–Ω–∫—Ü—ñ—ó</button>
            <button class="tab-btn" onclick="switchTab('users')">–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</button>
            <button class="tab-btn" onclick="switchTab('analytics')">–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ó–∞–≤–¥–∞–Ω–Ω—è -->
        <div id="tasksTab" class="tab-content active">
            <div class="controls">
                <button class="btn btn-success" onclick="openTaskModal()">+ –î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</button>
                <button class="btn" onclick="exportToCSV()">üìä –ï–∫—Å–ø–æ—Ä—Ç CSV</button>
                <div class="filters">
                    <button class="btn btn-clear" onclick="clearFilters()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏</button>
                    <select class="filter-select" id="pinnedFilter" onchange="applyFilters()">
                        <option value="">–í—Å—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</option>
                        <option value="pinned">–ó–∞–∫—Ä—ñ–ø–ª–µ–Ω—ñ</option>
                        <option value="unpinned">–ù–µ –∑–∞–∫—Ä—ñ–ø–ª–µ–Ω—ñ</option>
                    </select>
                    <select class="filter-select" id="dateFilter" onchange="applyFilters()">
                        <option value="">–í—Å—ñ –¥–∞—Ç–∏</option>
                        <option value="today">–°—å–æ–≥–æ–¥–Ω—ñ</option>
                        <option value="week">–¢–∏–∂–¥–µ–Ω—å</option>
                        <option value="month">–ú—ñ—Å—è—Ü—å</option>
                        <option value="overdue">–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ</option>
                        <option value="custom">–ü–µ—Ä—ñ–æ–¥</option>
                    </select>
                    <div id="dateRangeInputs">
                        <input type="date" id="dateFrom" class="filter-select" onchange="applyFilters()">
                        <span>‚Äî</span>
                        <input type="date" id="dateTo" class="filter-select" onchange="applyFilters()">
                    </div>
                    <select class="filter-select" id="statusFilter" onchange="applyFilters()">
                        <option value="">–°—Ç–∞—Ç—É—Å–∏</option>
                        <option value="new">–ù–æ–≤—ñ</option>
                        <option value="progress">–í —Ä–æ–±–æ—Ç—ñ</option>
                        <option value="review">–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞</option>
                        <option value="done">–ì–æ—Ç–æ–≤–æ</option>
                    </select>
                    <select class="filter-select" id="functionFilter" onchange="applyFilters()">
                        <option value="">–§—É–Ω–∫—Ü—ñ—ó</option>
                    </select>
                    <select class="filter-select" id="assigneeFilter" onchange="applyFilters()">
                        <option value="">–í–∏–∫–æ–Ω–∞–≤—Ü—ñ</option>
                    </select>
                </div>
            </div>
            <div class="tasks-grid" id="tasksContainer"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ö–æ–Ω—Ç—Ä–æ–ª—å -->
        <div id="controlTab" class="tab-content">
            <div class="control-dashboard">
                <h2 style="margin-bottom: 1.5rem; color: #2c3e50;">–ü–∞–Ω–µ–ª—å –∫–æ–Ω—Ç—Ä–æ–ª—é –∑–∞–≤–¥–∞–Ω—å</h2>
                <div class="control-overview">
                    <div class="control-card urgent">
                        <h3>üö® –ö—Ä–∏—Ç–∏—á–Ω—ñ</h3>
                        <div class="control-number" id="urgentCount">0</div>
                        <p>–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω—ñ</p>
                    </div>
                    <div class="control-card warning">
                        <h3>‚ö†Ô∏è –£–≤–∞–≥–∞</h3>
                        <div class="control-number" id="warningCount">0</div>
                        <p>–°—å–æ–≥–æ–¥–Ω—ñ-–∑–∞–≤—Ç—Ä–∞</p>
                    </div>
                    <div class="control-card active">
                        <h3>üîÑ –ê–∫—Ç–∏–≤–Ω—ñ</h3>
                        <div class="control-number" id="activeCount">0</div>
                        <p>–í —Ä–æ–±–æ—Ç—ñ</p>
                    </div>
                    <div class="control-card completed">
                        <h3>‚úÖ –ì–æ—Ç–æ–≤–æ</h3>
                        <div class="control-number" id="completedCount">0</div>
                        <p>–ó–∞–≤–µ—Ä—à–µ–Ω—ñ</p>
                    </div>
                </div>
                <div class="control-filters">
                    <label style="font-weight: 600; color: #2c3e50;">–ü–µ—Ä–µ–≥–ª—è–¥:</label>
                    <select id="controlView" onchange="updateControlView()" class="filter-select">
                        <option value="workload">–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</option>
                        <option value="deadlines">–î–µ–¥–ª–∞–π–Ω–∏</option>
                        <option value="functions">–§—É–Ω–∫—Ü—ñ—ó</option>
                    </select>
                </div>
                <div id="controlContent"></div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –†–µ–≥—É–ª—è—Ä–Ω—ñ -->
        <div id="regularTab" class="tab-content">
            <div class="controls">
                <button class="btn btn-success" onclick="openRegularTaskModal()">+ –†–µ–≥—É–ª—è—Ä–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è</button>
            </div>
            <div id="regularTasksContainer"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –§—É–Ω–∫—Ü—ñ—ó -->
        <div id="functionsTab" class="tab-content">
            <div class="controls">
                <button class="btn btn-success" onclick="openFunctionModal()">+ –î–æ–¥–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é</button>
            </div>
            <div id="functionsContainer" class="functions-grid"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏ -->
        <div id="usersTab" class="tab-content">
            <div class="controls">
                <button class="btn btn-success" onclick="openUserModal()">+ –î–æ–¥–∞—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞</button>
                <button class="btn" onclick="openInviteModal()" style="background: #f39c12;">üì§ –ó–∞–ø—Ä–æ—Å–∏—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞</button>
            </div>
            <div id="usersContainer" class="functions-grid"></div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ -->
        <div id="analyticsTab" class="tab-content">
            <div class="analytics-container">
                <div class="analytics-cards">
                    <div class="analytics-card">
                        <h3>–í—Å—å–æ–≥–æ –∑–∞–≤–¥–∞–Ω—å</h3>
                        <div class="analytics-number" id="totalTasksCount">0</div>
                    </div>
                    <div class="analytics-card">
                        <h3>–í–∏–∫–æ–Ω–∞–Ω–æ</h3>
                        <div class="analytics-number" id="completedTasksCount">0</div>
                    </div>
                    <div class="analytics-card">
                        <h3>–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ</h3>
                        <div class="analytics-number" id="overdueTasksCount">0</div>
                    </div>
                    <div class="analytics-card">
                        <h3>–ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</h3>
                        <div class="analytics-number" id="efficiencyPercent">0%</div>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="chart-container">
                        <h3>–°—Ç–∞—Ç—É—Å–∏ –∑–∞–≤–¥–∞–Ω—å</h3>
                        <div id="statusChart"></div>
                    </div>
                    <div class="chart-container">
                        <h3>–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</h3>
                        <div id="workloadChart"></div>
                    </div>
                </div>
            </div>
        </div>
        </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ñ –≤—ñ–∫–Ω–∞ -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeTaskModal()">&times;</span>
                <h2 id="modalTitle">–î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</h2>
            </div>
            <div class="modal-body">
                <form id="taskForm">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label">–ù–∞–∑–≤–∞ –∑–∞–≤–¥–∞–Ω–Ω—è:</label>
                            <input type="text" id="taskTitle" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–§—É–Ω–∫—Ü—ñ—è:</label>
                            <select id="taskFunction" class="form-select">
                                <option value="">–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π:</label>
                            <select id="taskAssignee" class="form-select" required>
                                <option value="">–û–±–µ—Ä—ñ—Ç—å –≤–∏–∫–æ–Ω–∞–≤—Ü—è</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–î–µ–¥–ª–∞–π–Ω:</label>
                            <input type="datetime-local" id="taskDeadline" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–¢–∏–ø:</label>
                            <select id="taskType" class="form-select">
                                <option value="single">–†–∞–∑–æ–≤–µ</option>
                                <option value="regular">–†–µ–≥—É–ª—è—Ä–Ω–µ</option>
                                <option value="bottleneck">–í—É–∑—å–∫–µ –º—ñ—Å—Ü–µ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–°—Ç–∞—Ç—É—Å:</label>
                            <select id="taskStatus" class="form-select">
                                <option value="new">–ù–æ–≤–µ</option>
                                <option value="progress">–í —Ä–æ–±–æ—Ç—ñ</option>
                                <option value="review">–ù–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ</option>
                                <option value="done">–ì–æ—Ç–æ–≤–æ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ó–∞–∫—Ä—ñ–ø–∏—Ç–∏:</label>
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;">
                                <input type="checkbox" id="taskPinned">
                                <span>–ó–∞–∫—Ä—ñ–ø–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç:</label>
                            <select id="taskPriority" class="form-select">
                                <option value="low">–ù–∏–∑—å–∫–∏–π</option>
                                <option value="medium">–°–µ—Ä–µ–¥–Ω—ñ–π</option>
                                <option value="high">–í–∏—Å–æ–∫–∏–π</option>
                            </select>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:</label>
                            <textarea id="taskInfo" class="form-textarea" placeholder="–î–µ—Ç–∞–ª—ñ –∑–∞–≤–¥–∞–Ω–Ω—è, –∫–æ–Ω—Ç–µ–∫—Å—Ç, –≤–∏–º–æ–≥–∏..."></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–Ø–∫ –∑–≤—ñ—Ç—É–≤–∞—Ç–∏—Å—è:</label>
                            <textarea id="taskReporting" class="form-textarea" placeholder="–ö—É–¥–∏ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –∑–≤—ñ—Ç, —É —è–∫–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ..."></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–≤–¥–∞–Ω–Ω—è:</label>
                            <textarea id="taskResult" class="form-textarea" placeholder="–©–æ –∑—Ä–æ–±–ª–µ–Ω–æ, —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏, –≤–∏—Å–Ω–æ–≤–∫–∏..."></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button type="button" class="btn" onclick="closeTaskModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button type="submit" class="btn btn-success">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="functionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeFunctionModal()">&times;</span>
                <h2>–î–æ–¥–∞—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é</h2>
            </div>
            <div class="modal-body">
                <form id="functionForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">–ù–∞–∑–≤–∞:</label>
                            <input type="text" id="functionName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ö–æ–ª—ñ—Ä:</label>
                            <input type="color" id="functionColor" class="form-input" value="#3498db">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–û–ø–∏—Å:</label>
                            <textarea id="functionDescription" class="form-textarea"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ:</label>
                            <div id="functionAssignees"></div>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button type="button" class="btn" onclick="closeFunctionModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button type="submit" class="btn btn-success">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="regularTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeRegularTaskModal()">&times;</span>
                <h2>–†–µ–≥—É–ª—è—Ä–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è</h2>
            </div>
            <div class="modal-body">
                <form id="regularTaskForm">
                    <div class="form-grid">
                        <div class="form-group full-width">
                            <label class="form-label">–ù–∞–∑–≤–∞:</label>
                            <input type="text" id="regularTaskTitle" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–§—É–Ω–∫—Ü—ñ—è:</label>
                            <select id="regularTaskFunction" class="form-select">
                                <option value="">–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π:</label>
                            <select id="regularTaskAssignee" class="form-select" required>
                                <option value="">–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ü–µ—Ä—ñ–æ–¥–∏—á–Ω—ñ—Å—Ç—å:</label>
                            <select id="regularTaskPeriod" class="form-select" onchange="updatePeriodOptions()">
                                <option value="daily">–©–æ–¥–Ω—è</option>
                                <option value="weekly">–©–æ—Ç–∏–∂–Ω—è</option>
                                <option value="monthly">–©–æ–º—ñ—Å—è—Ü—è</option>
                                <option value="workdays">–†–æ–±–æ—á—ñ –¥–Ω—ñ</option>
                                <option value="weekends">–í–∏—Ö—ñ–¥–Ω—ñ</option>
                                <option value="custom">–í–∏–±—Ä–∞–Ω—ñ –¥–Ω—ñ</option>
                            </select>
                        </div>
                        <div class="form-group" id="customDaysContainer" style="display: none;">
                            <label class="form-label">–î–Ω—ñ —Ç–∏–∂–Ω—è:</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.3rem;">
                                    <input type="checkbox" name="customDays" value="1"> –ü–æ–Ω–µ–¥—ñ–ª–æ–∫
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.3rem;">
                                    <input type="checkbox" name="customDays" value="2"> –í—ñ–≤—Ç–æ—Ä–æ–∫
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.3rem;">
                                    <input type="checkbox" name="customDays" value="3"> –°–µ—Ä–µ–¥–∞
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.3rem;">
                                    <input type="checkbox" name="customDays" value="4"> –ß–µ—Ç–≤–µ—Ä
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.3rem;">
                                    <input type="checkbox" name="customDays" value="5"> –ü'—è—Ç–Ω–∏—Ü—è
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.3rem;">
                                    <input type="checkbox" name="customDays" value="6"> –°—É–±–æ—Ç–∞
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.3rem;">
                                    <input type="checkbox" name="customDays" value="0"> –ù–µ–¥—ñ–ª—è
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–î–Ω—ñ–≤ –Ω–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:</label>
                            <input type="number" id="regularTaskDuration" class="form-input" value="1" min="1" max="30">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–û–ø–∏—Å:</label>
                            <textarea id="regularTaskDescription" class="form-textarea"></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button type="button" class="btn" onclick="closeRegularTaskModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button type="submit" class="btn btn-success">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ -->
    <div id="userModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeUserModal()">&times;</span>
                <h2 id="userModalTitle">–î–æ–¥–∞—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞</h2>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">–Ü–º'—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ:</label>
                            <input type="text" id="userName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email:</label>
                            <input type="email" id="userEmail" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω:</label>
                            <input type="tel" id="userPhone" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–†–æ–ª—å:</label>
                            <select id="userRole" class="form-select" required>
                                <option value="employee">–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</option>
                                <option value="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
                                <option value="owner">–í–ª–∞—Å–Ω–∏–∫</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ü–æ—Å–∞–¥–∞:</label>
                            <input type="text" id="userPosition" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:</label>
                            <input type="text" id="userDepartment" class="form-input">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è:</label>
                            <textarea id="userNotes" class="form-textarea" placeholder="–î–æ—Å–≤—ñ–¥, –Ω–∞–≤–∏—á–∫–∏, –æ—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ..."></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button type="button" class="btn" onclick="closeUserModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button type="submit" class="btn btn-success">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="inviteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeInviteModal()">&times;</span>
                <h2>üì§ –ó–∞–ø—Ä–æ—Å–∏—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞</h2>
            </div>
            <div class="modal-body">
                <form id="inviteFormModal">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Email —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞:</label>
                            <input type="email" id="inviteEmail" class="form-input" required placeholder="colleague@email.com">
                        </div>
                        <div class="form-group">
                            <label class="form-label">–†–æ–ª—å:</label>
                            <select id="inviteRole" class="form-select" required>
                                <option value="employee">–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫</option>
                                <option value="manager">–ú–µ–Ω–µ–¥–∂–µ—Ä</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–§—É–Ω–∫—Ü—ñ—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ):</label>
                            <select id="inviteFunction" class="form-select">
                                <option value="">–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">–ü–æ—Å–∞–¥–∞:</label>
                            <input type="text" id="invitePosition" class="form-input" placeholder="–†–æ–∑—Ä–æ–±–Ω–∏–∫, –î–∏–∑–∞–π–Ω–µ—Ä...">
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ):</label>
                            <textarea id="inviteMessage" class="form-textarea" placeholder="–í—ñ—Ç–∞—î–º–æ –≤ –∫–æ–º–∞–Ω–¥—ñ TALKO System!"></textarea>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; text-align: right;">
                        <button type="button" class="btn" onclick="closeInviteModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button type="submit" class="btn btn-success">üì§ –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="inviteLinkModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeInviteLinkModal()">&times;</span>
                <h2>‚úÖ –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ!</h2>
            </div>
            <div class="modal-body">
                <div style="text-align: center;">
                    <div style="background: #e8f5e8; padding: 1.5rem; border-radius: 10px; margin-bottom: 1.5rem;">
                        <p style="margin-bottom: 1rem; color: #27ae60; font-weight: 600;">üìß –°–∫–æ–ø—ñ—é–π—Ç–µ —Ü–µ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤—Ç–µ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—É:</p>
                        <div style="background: white; padding: 1rem; border-radius: 5px; border: 2px dashed #27ae60; word-break: break-all; font-family: monospace; font-size: 0.9rem;" id="inviteLinkText"></div>
                    </div>
                    
                    <button onclick="copyInviteLink()" class="btn btn-success" style="margin-right: 0.5rem;">
                        üìã –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
                    </button>
                    <button onclick="shareInviteEmail()" class="btn" style="background: #3498db;">
                        üìß –í—ñ–¥–∫—Ä–∏—Ç–∏ Email
                    </button>
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 5px; font-size: 0.85rem; color: #7f8c8d;">
                        üí° <strong>–ü–æ—Å–∏–ª–∞–Ω–Ω—è –¥—ñ—î 7 –¥–Ω—ñ–≤</strong><br>
                        –°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫ –∑–º–æ–∂–µ –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è —Ç–∞ –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ —Å–∏—Å—Ç–µ–º–∏
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tasks = [], users = [
            {id: 1, name: "–û–ª–µ–∫—Å–∞–Ω–¥—Ä –¢–∞–ª—å–∫–æ", role: "owner", email: "management.talco@gmail.com", phone: "+380501234567", position: "CEO", department: "–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è", notes: "–ó–∞—Å–Ω–æ–≤–Ω–∏–∫ TALKO System"},
            {id: 2, name: "–ú–∞—Ä—ñ—è –ü–µ—Ç—Ä–µ–Ω–∫–æ", role: "manager", email: "maria@talko.com", phone: "+380501234568", position: "–ú–µ–Ω–µ–¥–∂–µ—Ä –∑ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É", department: "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥", notes: "5 —Ä–æ–∫—ñ–≤ –¥–æ—Å–≤—ñ–¥—É –≤ digital-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É"},
            {id: 3, name: "–Ü–≤–∞–Ω –ö–æ–≤–∞–ª–µ–Ω–∫–æ", role: "employee", email: "ivan@talko.com", phone: "+380501234569", position: "–†–æ–∑—Ä–æ–±–Ω–∏–∫", department: "IT", notes: "Frontend/Backend —Ä–æ–∑—Ä–æ–±–∫–∞"},
            {id: 4, name: "–û–ª—å–≥–∞ –°–∏–¥–æ—Ä–µ–Ω–∫–æ", role: "employee", email: "olga@talko.com", phone: "+380501234570", position: "–î–∏–∑–∞–π–Ω–µ—Ä", department: "–î–∏–∑–∞–π–Ω", notes: "UI/UX –¥–∏–∑–∞–π–Ω, –±—Ä–µ–Ω–¥–∏–Ω–≥"}
        ], functions = [], regularTasks = [], currentUser = {name: "–û–ª–µ–∫—Å–∞–Ω–¥—Ä –¢–∞–ª—å–∫–æ", role: "owner"}, activeTab = 'tasks', editingTaskId = null, editingUserId = null;

        // üîê –ó–ú–Ü–ù–ù–Ü –ê–í–¢–û–†–ò–ó–ê–¶–Ü–á
        let isAuthenticated = false;
        let authCodes = {}; // –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∫–æ–¥—ñ–≤ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
        let inviteCodes = {}; // –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∑–∞–ø—Ä–æ—à–µ–Ω—å
        let currentAuthEmail = '';
        let currentInviteCode = '';

        // üîí –°–ò–°–¢–ï–ú–ê –ü–†–ê–í –î–û–°–¢–£–ü–£
        function hasPermission(action) {
            const role = currentUser.role;
            const permissions = {
                owner: ['all'],
                manager: ['viewAll', 'createTasks', 'editTasks', 'deleteTasks', 'createRegular', 'assignFunctions', 'extendDeadlines', 'manageUsers'],
                employee: ['viewOwn', 'createTasks', 'editOwnTasks', 'changeStatus', 'comment']
            };
            return permissions[role]?.includes('all') || permissions[role]?.includes(action);
        }

        function canViewTask(task) {
            if (hasPermission('viewAll')) return true;
            if (hasPermission('viewOwn')) {
                return task.assignee === currentUser.name || task.creator === currentUser.name;
            }
            return false;
        }

        function canEditTask(task) {
            if (hasPermission('editTasks')) return true;
            if (hasPermission('editOwnTasks')) {
                return task.assignee === currentUser.name || task.creator === currentUser.name;
            }
            return false;
        }

        function canDeleteTask(task) {
            if (hasPermission('deleteTasks')) return true;
            return task.creator === currentUser.name;
        }

        function showPermissionError() {
            alert('‚ùå –£ –≤–∞—Å –Ω–µ–º–∞—î –ø—Ä–∞–≤ –¥–ª—è —Ü—ñ—î—ó –¥—ñ—ó');
        }

        function updateCurrentUserInfo() {
            const roleText = {owner: '–í–ª–∞—Å–Ω–∏–∫', manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä', employee: '–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫'}[currentUser.role] || '–ù–µ–≤—ñ–¥–æ–º–∞ —Ä–æ–ª—å';
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('currentUserRole').textContent = `(${roleText})`;
        }

        // üß™ –¢–ï–°–¢–£–í–ê–ù–ù–Ø –†–û–õ–ï–ô (—Ç–∏–º—á–∞—Å–æ–≤–æ)
        function switchUserForTesting() {
            const testUsers = [
                {name: "–û–ª–µ–∫—Å–∞–Ω–¥—Ä –¢–∞–ª—å–∫–æ", role: "owner"},
                {name: "–ú–∞—Ä—ñ—è –ü–µ—Ç—Ä–µ–Ω–∫–æ", role: "manager"},
                {name: "–Ü–≤–∞–Ω –ö–æ–≤–∞–ª–µ–Ω–∫–æ", role: "employee"}
            ];
            
            const currentIndex = testUsers.findIndex(u => u.name === currentUser.name);
            const nextIndex = (currentIndex + 1) % testUsers.length;
            currentUser = testUsers[nextIndex];
            
            updateCurrentUserInfo();
            renderTasks();
            alert(`üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞: ${currentUser.name} (${currentUser.role})`);
        }

        // üîê –§–£–ù–ö–¶–Ü–á –ê–í–¢–û–†–ò–ó–ê–¶–Ü–á
        function checkAuthentication() {
            const session = localStorage.getItem('authSession');
            if (session) {
                const sessionData = JSON.parse(session);
                const user = users.find(u => u.email === sessionData.email);
                if (user) {
                    currentUser = user;
                    isAuthenticated = true;
                    showMainInterface();
                    updateCurrentUserInfo();
                    return;
                }
            }
            showAuthPage();
        }

        function showAuthPage() {
            document.getElementById('authPage').style.display = 'block';
            document.getElementById('mainInterface').style.display = 'none';
            
            // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ —î –∫–æ–¥ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è –≤ URL
            const urlParams = new URLSearchParams(window.location.search);
            const inviteCode = urlParams.get('invite');
            if (inviteCode) {
                showInviteForm(inviteCode);
            }
        }

        function showMainInterface() {
            document.getElementById('authPage').style.display = 'none';
            document.getElementById('mainInterface').style.display = 'block';
        }

        function sendLoginCode() {
            const email = document.getElementById('loginEmail').value.trim();
            if (!email) {
                alert('–í–≤–µ–¥—ñ—Ç—å email');
                return;
            }

            const user = users.find(u => u.email === email);
            if (!user) {
                alert('‚ùå –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —Ç–∞–∫–∏–º email –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                return;
            }

            // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–¥—É
            const code = Math.floor(100000 + Math.random() * 900000).toString();
            authCodes[email] = {
                code: code,
                expiry: Date.now() + 10 * 60 * 1000 // 10 —Ö–≤–∏–ª–∏–Ω
            };
            
            currentAuthEmail = email;

            // –ü–æ–∫–∞–∑ –∫–æ–¥—É (–∑–∞–º—ñ—Å—Ç—å –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ email)
            alert(`üìß –ö–æ–¥ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è: ${code}\n(–í —Ä–µ–∞–ª—å–Ω—ñ–π —Å–∏—Å—Ç–µ–º—ñ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç—å—Å—è –Ω–∞ email)`);

            // –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç–∏—Å—å –Ω–∞ —Ñ–æ—Ä–º—É –≤–≤–µ–¥–µ–Ω–Ω—è –∫–æ–¥—É
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('codeForm').style.display = 'block';
        }

        function verifyLoginCode() {
            const enteredCode = document.getElementById('loginCode').value.trim();
            const authData = authCodes[currentAuthEmail];

            if (!authData) {
                alert('‚ùå –ö–æ–¥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                return;
            }

            if (Date.now() > authData.expiry) {
                alert('‚ùå –ö–æ–¥ –ø—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–∏–π');
                delete authCodes[currentAuthEmail];
                backToLogin();
                return;
            }

            if (enteredCode !== authData.code) {
                alert('‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –∫–æ–¥');
                return;
            }

            // –£—Å–ø—ñ—à–Ω–∏–π –≤—Ö—ñ–¥
            const user = users.find(u => u.email === currentAuthEmail);
            currentUser = user;
            isAuthenticated = true;

            // –ó–±–µ—Ä–µ–≥—Ç–∏ —Å–µ—Å—ñ—é
            localStorage.setItem('authSession', JSON.stringify({
                email: currentAuthEmail,
                loginTime: Date.now()
            }));

            // –û—á–∏—Å—Ç–∏—Ç–∏ –∫–æ–¥
            delete authCodes[currentAuthEmail];

            showMainInterface();
            updateCurrentUserInfo();
            renderTasks();
            alert(`üéâ –í—ñ—Ç–∞—î–º–æ, ${currentUser.name}!`);
        }

        function backToLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('codeForm').style.display = 'none';
            document.getElementById('loginCode').value = '';
        }

        function logout() {
            localStorage.removeItem('authSession');
            isAuthenticated = false;
            currentUser = null;
            showAuthPage();
        }

        // üì§ –°–ò–°–¢–ï–ú–ê –ó–ê–ü–†–û–®–ï–ù–¨
        function openInviteModal() {
            if (!hasPermission('manageUsers')) {
                showPermissionError();
                return;
            }
            
            document.getElementById('inviteModal').style.display = 'block';
            updateInviteFunctionSelect();
            clearInviteForm();
        }

        function closeInviteModal() {
            document.getElementById('inviteModal').style.display = 'none';
        }

        function closeInviteLinkModal() {
            document.getElementById('inviteLinkModal').style.display = 'none';
        }

        function clearInviteForm() {
            document.getElementById('inviteEmail').value = '';
            document.getElementById('inviteRole').value = 'employee';
            document.getElementById('inviteFunction').value = '';
            document.getElementById('invitePosition').value = '';
            document.getElementById('inviteMessage').value = '';
        }

        function updateInviteFunctionSelect() {
            const select = document.getElementById('inviteFunction');
            select.innerHTML = '<option value="">–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó</option>' + 
                functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
        }

        function createInvite() {
            const email = document.getElementById('inviteEmail').value.trim();
            const role = document.getElementById('inviteRole').value;
            const functionName = document.getElementById('inviteFunction').value;
            const position = document.getElementById('invitePosition').value.trim();
            const message = document.getElementById('inviteMessage').value.trim();

            if (!email) {
                alert('–í–≤–µ–¥—ñ—Ç—å email —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞');
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤–∂–µ —ñ—Å–Ω—É—î
            const existingUser = users.find(u => u.email === email);
            if (existingUser) {
                alert('‚ùå –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º email –≤–∂–µ —ñ—Å–Ω—É—î –≤ —Å–∏—Å—Ç–µ–º—ñ');
                return;
            }

            // –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –∫–æ–¥—É –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è
            const inviteCode = 'INV-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            
            // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è
            inviteCodes[inviteCode] = {
                email: email,
                role: role,
                function: functionName,
                position: position,
                message: message,
                invitedBy: currentUser.name,
                createdAt: Date.now(),
                expiresAt: Date.now() + 7 * 24 * 60 * 60 * 1000, // 7 –¥–Ω—ñ–≤
                used: false
            };

            localStorage.setItem('inviteCodes', JSON.stringify(inviteCodes));

            // –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è
            const currentUrl = window.location.origin + window.location.pathname;
            const inviteLink = `${currentUrl}?invite=${inviteCode}`;
            
            currentInviteCode = inviteCode;
            document.getElementById('inviteLinkText').textContent = inviteLink;

            closeInviteModal();
            document.getElementById('inviteLinkModal').style.display = 'block';
        }

        function copyInviteLink() {
            const linkText = document.getElementById('inviteLinkText').textContent;
            navigator.clipboard.writeText(linkText).then(() => {
                alert('üìã –ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º—ñ–Ω—É!');
            }).catch(() => {
                // Fallback –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –±—Ä–∞—É–∑–µ—Ä—ñ–≤
                const textArea = document.createElement('textarea');
                textArea.value = linkText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('üìã –ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');
            });
        }

        function shareInviteEmail() {
            const invite = inviteCodes[currentInviteCode];
            const linkText = document.getElementById('inviteLinkText').textContent;
            
            const subject = encodeURIComponent('–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –¥–æ TALKO System');
            const body = encodeURIComponent(`–í—ñ—Ç–∞—î–º–æ!

–í–∞—Å –∑–∞–ø—Ä–æ—à—É—é—Ç—å –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ —Å–∏—Å—Ç–µ–º–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω–Ω—è–º–∏ TALKO System.

${invite.message ? '–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: ' + invite.message + '\n\n' : ''}–†–æ–ª—å: ${invite.role === 'manager' ? '–ú–µ–Ω–µ–¥–∂–µ—Ä' : '–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫'}
${invite.position ? '–ü–æ—Å–∞–¥–∞: ' + invite.position + '\n' : ''}${invite.function ? '–§—É–Ω–∫—Ü—ñ—è: ' + invite.function + '\n' : ''}
–î–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –ø–µ—Ä–µ–π–¥—ñ—Ç—å –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º:
${linkText}

–ü–æ—Å–∏–ª–∞–Ω–Ω—è –¥—ñ—î 7 –¥–Ω—ñ–≤.

–ó –ø–æ–≤–∞–≥–æ—é,
–ö–æ–º–∞–Ω–¥–∞ TALKO System`);

            const mailtoLink = `mailto:${invite.email}?subject=${subject}&body=${body}`;
            window.open(mailtoLink);
        }

        function showInviteForm(inviteCode) {
            const invite = inviteCodes[inviteCode];
            
            if (!invite) {
                alert('‚ùå –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ –∞–±–æ –Ω–µ–¥—ñ–π—Å–Ω–µ');
                showAuthPage();
                return;
            }

            if (invite.used) {
                alert('‚ùå –¶–µ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ');
                showAuthPage();
                return;
            }

            if (Date.now() > invite.expiresAt) {
                alert('‚ùå –¢–µ—Ä–º—ñ–Ω –¥—ñ—ó –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è –º–∏–Ω—É–≤');
                showAuthPage();
                return;
            }

            // –ü–æ–∫–∞–∑–∞—Ç–∏ —Ñ–æ—Ä–º—É —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('inviteForm').style.display = 'block';
            
            currentInviteCode = inviteCode;
        }

        function completeRegistration() {
            const name = document.getElementById('inviteName').value.trim();
            const phone = document.getElementById('invitePhone').value.trim();

            if (!name) {
                alert('–í–≤–µ–¥—ñ—Ç—å —ñ–º\'—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ');
                return;
            }

            const invite = inviteCodes[currentInviteCode];
            if (!invite) {
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è');
                return;
            }

            // –°—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            const newUser = {
                id: Math.max(...users.map(u => u.id || 0), 0) + 1,
                name: name,
                email: invite.email,
                phone: phone,
                role: invite.role,
                position: invite.position || '',
                department: invite.function || '',
                notes: `–ü—Ä–∏—î–¥–Ω–∞–≤—Å—è –∑–∞ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è–º –≤—ñ–¥ ${invite.invitedBy}`
            };

            users.push(newUser);

            // –î–æ–¥–∞—Ç–∏ –¥–æ —Ñ—É–Ω–∫—Ü—ñ—ó —è–∫—â–æ –≤–∫–∞–∑–∞–Ω–æ
            if (invite.function) {
                const func = functions.find(f => f.name === invite.function);
                if (func && !func.assignees.includes(name)) {
                    func.assignees.push(name);
                }
            }

            // –ü–æ–∑–Ω–∞—á–∏—Ç–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è —è–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–µ
            invite.used = true;
            invite.usedAt = Date.now();

            // –ê–≤—Ç–æ—Ä–∏–∑—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
            currentUser = newUser;
            isAuthenticated = true;

            // –ó–±–µ—Ä–µ–≥—Ç–∏ –¥–∞–Ω—ñ
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('functions', JSON.stringify(functions));
            localStorage.setItem('inviteCodes', JSON.stringify(inviteCodes));
            localStorage.setItem('authSession', JSON.stringify({
                email: newUser.email,
                loginTime: Date.now()
            }));

            showMainInterface();
            updateCurrentUserInfo();
            renderTasks();
            alert(`üéâ –í—ñ—Ç–∞—î–º–æ –≤ –∫–æ–º–∞–Ω–¥—ñ, ${newUser.name}!`);
        }

        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            checkAuthentication(); // –ü–µ—Ä–µ–≤—ñ—Ä—è—î —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑–∞–ª–æ–≥—ñ–Ω–µ–Ω–∏–π
            updateSelects();
            renderTasks();
            ['taskForm','functionForm','regularTaskForm','userForm','inviteFormModal'].forEach(id => {
                document.getElementById(id).addEventListener('submit', function(e) {
                    e.preventDefault();
                    if(id==='taskForm') saveTask();
                    else if(id==='functionForm') saveFunction();
                    else if(id==='regularTaskForm') saveRegularTask();
                    else if(id==='userForm') saveUser();
                    else if(id==='inviteFormModal') createInvite();
                });
            });
        });

        function loadData() {
            tasks = JSON.parse(localStorage.getItem('tasks')) || [
                {id:1, title:"–ê–Ω–∞–ª—ñ–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ñ–≤", assignee:"–ú–∞—Ä—ñ—è –ü–µ—Ç—Ä–µ–Ω–∫–æ", creator:"–û–ª–µ–∫—Å–∞–Ω–¥—Ä –¢–∞–ª—å–∫–æ", createdDate:"2024-11-11T10:00", deadline:"2024-11-15T18:00", status:"progress", type:"single", function:"–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥", additionalInfo:"–¢–æ–ø-5 –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ñ–≤ —É —Å—Ñ–µ—Ä—ñ –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥—É", howToReport:"–°—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—é —Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –Ω–∞ email", result:"", priority:"high", pinned:true},
                {id:2, title:"–û–Ω–æ–≤–∏—Ç–∏ —Å–∞–π—Ç", assignee:"–Ü–≤–∞–Ω –ö–æ–≤–∞–ª–µ–Ω–∫–æ", creator:"–û–ª–µ–∫—Å–∞–Ω–¥—Ä –¢–∞–ª—å–∫–æ", createdDate:"2024-11-10T14:30", deadline:"2024-11-20T12:00", status:"new", type:"regular", function:"IT", additionalInfo:"–û–Ω–æ–≤–∏—Ç–∏ —Ç–µ–∫—Å—Ç–∏ –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ", howToReport:"–ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ –≤ Telegram –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è", result:"", priority:"medium", pinned:false}
            ];
            functions = JSON.parse(localStorage.getItem('functions')) || [
                {id:1, name:"–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥", description:"–†–µ–∫–ª–∞–º–∞ —ñ –ø—Ä–æ–º–æ—Ü—ñ—è", color:"#e74c3c", assignees:["–ú–∞—Ä—ñ—è –ü–µ—Ç—Ä–µ–Ω–∫–æ"]},
                {id:2, name:"–ü—Ä–æ–¥–∞–∂—ñ", description:"–†–æ–±–æ—Ç–∞ –∑ –∫–ª—ñ—î–Ω—Ç–∞–º–∏", color:"#27ae60", assignees:["–Ü–≤–∞–Ω –ö–æ–≤–∞–ª–µ–Ω–∫–æ"]},
                {id:3, name:"IT", description:"–¢–µ—Ö–ø—ñ–¥—Ç—Ä–∏–º–∫–∞", color:"#3498db", assignees:["–û–ª—å–≥–∞ –°–∏–¥–æ—Ä–µ–Ω–∫–æ"]}
            ];
            regularTasks = JSON.parse(localStorage.getItem('regularTasks')) || [];
            users = JSON.parse(localStorage.getItem('users')) || [
                {id: 1, name: "–û–ª–µ–∫—Å–∞–Ω–¥—Ä –¢–∞–ª—å–∫–æ", role: "owner", email: "management.talco@gmail.com", phone: "+380501234567", position: "CEO", department: "–£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è", notes: "–ó–∞—Å–Ω–æ–≤–Ω–∏–∫ TALKO System"},
                {id: 2, name: "–ú–∞—Ä—ñ—è –ü–µ—Ç—Ä–µ–Ω–∫–æ", role: "manager", email: "maria@talko.com", phone: "+380501234568", position: "–ú–µ–Ω–µ–¥–∂–µ—Ä –∑ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É", department: "–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥", notes: "5 —Ä–æ–∫—ñ–≤ –¥–æ—Å–≤—ñ–¥—É –≤ digital-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É"},
                {id: 3, name: "–Ü–≤–∞–Ω –ö–æ–≤–∞–ª–µ–Ω–∫–æ", role: "employee", email: "ivan@talko.com", phone: "+380501234569", position: "–†–æ–∑—Ä–æ–±–Ω–∏–∫", department: "IT", notes: "Frontend/Backend —Ä–æ–∑—Ä–æ–±–∫–∞"},
                {id: 4, name: "–û–ª—å–≥–∞ –°–∏–¥–æ—Ä–µ–Ω–∫–æ", role: "employee", email: "olga@talko.com", phone: "+380501234570", position: "–î–∏–∑–∞–π–Ω–µ—Ä", department: "–î–∏–∑–∞–π–Ω", notes: "UI/UX –¥–∏–∑–∞–π–Ω, –±—Ä–µ–Ω–¥–∏–Ω–≥"}
            ];
            inviteCodes = JSON.parse(localStorage.getItem('inviteCodes')) || {};
        }

        function saveData() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
            localStorage.setItem('functions', JSON.stringify(functions));
            localStorage.setItem('regularTasks', JSON.stringify(regularTasks));
            localStorage.setItem('users', JSON.stringify(users));
        }

        function switchTab(tabName) {
            activeTab = tabName;
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            switch(tabName) {
                case 'tasks': renderTasks(); break;
                case 'control': renderControlDashboard(); break;
                case 'regular': renderRegularTasks(); break;
                case 'functions': renderFunctions(); break;
                case 'users': renderUsers(); break;
                case 'analytics': renderAnalytics(); break;
            }
        }

        function openTaskModal(taskId = null) {
            if (taskId) {
                const task = tasks.find(t => t.id === taskId);
                if (task && !canEditTask(task)) {
                    showPermissionError();
                    return;
                }
            } else {
                if (!hasPermission('createTasks')) {
                    showPermissionError();
                    return;
                }
            }
            
            document.getElementById('taskModal').style.display = 'block';
            if (taskId) {
                editingTaskId = taskId;
                fillTaskForm(taskId);
                document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è';
            } else {
                editingTaskId = null;
                clearTaskForm();
                document.getElementById('modalTitle').textContent = '–î–æ–¥–∞—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è';
            }
        }

        function closeTaskModal() {
            document.getElementById('taskModal').style.display = 'none';
            editingTaskId = null;
        }

        function clearTaskForm() {
            ['taskTitle','taskFunction','taskAssignee','taskDeadline','taskInfo','taskReporting','taskResult'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('taskType').value = 'single';
            document.getElementById('taskStatus').value = 'new';
            document.getElementById('taskPriority').value = 'medium';
            document.getElementById('taskPinned').checked = false;
        }

        function fillTaskForm(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                document.getElementById('taskTitle').value = task.title;
                document.getElementById('taskFunction').value = task.function || '';
                document.getElementById('taskAssignee').value = task.assignee;
                document.getElementById('taskDeadline').value = task.deadline;
                document.getElementById('taskType').value = task.type;
                document.getElementById('taskStatus').value = task.status;
                document.getElementById('taskPriority').value = task.priority || 'medium';
                document.getElementById('taskPinned').checked = task.pinned || false;
                document.getElementById('taskInfo').value = task.additionalInfo || '';
                document.getElementById('taskReporting').value = task.howToReport || '';
                document.getElementById('taskResult').value = task.result || '';
            }
        }

        function saveTask() {
            const data = {
                title: document.getElementById('taskTitle').value,
                function: document.getElementById('taskFunction').value,
                assignee: document.getElementById('taskAssignee').value,
                deadline: document.getElementById('taskDeadline').value,
                type: document.getElementById('taskType').value,
                status: document.getElementById('taskStatus').value,
                priority: document.getElementById('taskPriority').value,
                pinned: document.getElementById('taskPinned').checked,
                additionalInfo: document.getElementById('taskInfo').value,
                howToReport: document.getElementById('taskReporting').value,
                result: document.getElementById('taskResult').value,
                creator: currentUser.name
            };

            if (!data.title || !data.assignee || !data.deadline) {
                alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è');
                return;
            }

            if (editingTaskId) {
                const idx = tasks.findIndex(t => t.id === editingTaskId);
                if (idx !== -1) tasks[idx] = {...tasks[idx], ...data};
                alert('–ó–∞–≤–¥–∞–Ω–Ω—è –æ–Ω–æ–≤–ª–µ–Ω–æ');
            } else {
                tasks.push({id: Date.now(), createdDate: new Date().toISOString(), ...data});
                alert('–ó–∞–≤–¥–∞–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ');
            }

            saveData();
            renderTasks();
            closeTaskModal();
        }

        function deleteTask(taskId) {
            const task = tasks.find(t => t.id === taskId);
            if (task && !canDeleteTask(task)) {
                showPermissionError();
                return;
            }
            
            if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è?')) {
                tasks = tasks.filter(t => t.id !== taskId);
                saveData();
                renderTasks();
                alert('–ó–∞–≤–¥–∞–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ');
            }
        }

        function togglePinTask(taskId) {
            const idx = tasks.findIndex(t => t.id === taskId);
            if (idx !== -1) {
                tasks[idx].pinned = !tasks[idx].pinned;
                saveData();
                renderTasks();
                alert(tasks[idx].pinned ? '–ó–∞–∫—Ä—ñ–ø–ª–µ–Ω–æ' : '–í—ñ–¥–∫—Ä—ñ–ø–ª–µ–Ω–æ');
            }
        }

        function getFilteredTasks() {
            const filters = {
                pinned: document.getElementById('pinnedFilter')?.value,
                date: document.getElementById('dateFilter')?.value,
                status: document.getElementById('statusFilter')?.value,
                function: document.getElementById('functionFilter')?.value,
                assignee: document.getElementById('assigneeFilter')?.value
            };

            return tasks.filter(task => {
                // üîí –ü–ï–†–ï–í–Ü–†–ö–ê –ü–†–ê–í –î–û–°–¢–£–ü–£
                if (!canViewTask(task)) return false;

                const matchesPinned = !filters.pinned || 
                    (filters.pinned === 'pinned' && task.pinned) ||
                    (filters.pinned === 'unpinned' && !task.pinned);

                let matchesDate = true;
                if (filters.date) {
                    const taskDate = new Date(task.deadline);
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    
                    switch(filters.date) {
                        case 'today':
                            const tomorrow = new Date(today);
                            tomorrow.setDate(tomorrow.getDate() + 1);
                            matchesDate = taskDate >= today && taskDate < tomorrow;
                            break;
                        case 'week':
                            const weekEnd = new Date(today);
                            weekEnd.setDate(weekEnd.getDate() + 7);
                            matchesDate = taskDate >= today && taskDate < weekEnd;
                            break;
                        case 'month':
                            const monthEnd = new Date(today);
                            monthEnd.setMonth(monthEnd.getMonth() + 1);
                            matchesDate = taskDate >= today && taskDate < monthEnd;
                            break;
                        case 'overdue':
                            matchesDate = taskDate < now && task.status !== 'done';
                            break;
                        case 'custom':
                            const dateFrom = document.getElementById('dateFrom')?.value;
                            const dateTo = document.getElementById('dateTo')?.value;
                            if (dateFrom && dateTo) {
                                const fromDate = new Date(dateFrom);
                                const toDate = new Date(dateTo + 'T23:59:59');
                                matchesDate = taskDate >= fromDate && taskDate <= toDate;
                            }
                            break;
                    }
                }

                return matchesPinned && matchesDate && 
                       (!filters.status || task.status === filters.status) &&
                       (!filters.function || task.function === filters.function) &&
                       (!filters.assignee || task.assignee === filters.assignee);
            });
        }

        function applyFilters() {
            const dateFilter = document.getElementById('dateFilter')?.value;
            const dateRangeInputs = document.getElementById('dateRangeInputs');
            if (dateRangeInputs) {
                dateRangeInputs.style.display = dateFilter === 'custom' ? 'flex' : 'none';
            }
            renderTasks();
        }

        function clearFilters() {
            ['pinnedFilter','dateFilter','statusFilter','functionFilter','assigneeFilter','dateFrom','dateTo'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = '';
            });
            document.getElementById('dateRangeInputs').style.display = 'none';
            renderTasks();
        }

        function renderTasks() {
            const container = document.getElementById('tasksContainer');
            const filtered = getFilteredTasks();
            const sorted = [...filtered].sort((a, b) => {
                if (a.pinned && !b.pinned) return -1;
                if (!a.pinned && b.pinned) return 1;
                return new Date(a.deadline) - new Date(b.deadline);
            });

            if (sorted.length === 0) {
                container.innerHTML = `
                    <div class="task-header">
                        <div>–ó–∞–≤–¥–∞–Ω–Ω—è</div><div>–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å</div><div>–°—Ç–≤–æ—Ä–∏–≤</div>
                        <div>–î–µ–¥–ª–∞–π–Ω</div><div>–°—Ç–∞—Ç—É—Å</div><div>–¢–∏–ø</div><div>–î—ñ—ó</div>
                    </div>
                    <div class="empty-state">
                        <h3>–ó–∞–≤–¥–∞–Ω—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</h3>
                        <p>–ó–º—ñ–Ω—ñ—Ç—å —Ñ—ñ–ª—å—Ç—Ä–∏ –∞–±–æ –¥–æ–¥–∞–π—Ç–µ –Ω–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è</p>
                    </div>`;
                return;
            }

            container.innerHTML = `
                <div class="task-header">
                    <div>–ó–∞–≤–¥–∞–Ω–Ω—è</div><div>–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å</div><div>–°—Ç–≤–æ—Ä–∏–≤</div>
                    <div>–î–µ–¥–ª–∞–π–Ω</div><div>–°—Ç–∞—Ç—É—Å</div><div>–¢–∏–ø</div><div>–î—ñ—ó</div>
                </div>
                ${sorted.map(task => `
                    <div class="task-row ${task.pinned ? 'pinned' : ''}">
                        <div>
                            <div class="task-title-container">
                                <button class="pin-btn ${task.pinned ? 'pinned' : ''}" onclick="togglePinTask(${task.id})" title="${task.pinned ? '–í—ñ–¥–∫—Ä—ñ–ø–∏—Ç–∏' : '–ó–∞–∫—Ä—ñ–ø–∏—Ç–∏'}">üìå</button>
                                <div class="task-title">${task.title}</div>
                            </div>
                            ${task.additionalInfo ? `<div class="task-info">${task.additionalInfo}</div>` : ''}
                        </div>
                        <div>${task.assignee}</div>
                        <div>${task.creator}</div>
                        <div>${formatDateTime(task.deadline)}</div>
                        <div><span class="status-badge status-${task.status}">${getStatusText(task.status)}</span></div>
                        <div><span class="type-badge type-${task.type}">${getTypeText(task.type)}</span></div>
                        <div>
                            ${canEditTask(task) ? `<button class="btn btn-small" onclick="openTaskModal(${task.id})">‚úèÔ∏è</button>` : ''}
                            ${canDeleteTask(task) ? `<button class="btn btn-small btn-danger" onclick="deleteTask(${task.id})" style="margin-left: 0.3rem;">üóëÔ∏è</button>` : ''}
                            ${!canEditTask(task) && !canDeleteTask(task) ? '<span style="color: #7f8c8d; font-size: 0.8rem;">–¢—ñ–ª—å–∫–∏ –ø–µ—Ä–µ–≥–ª—è–¥</span>' : ''}
                        </div>
                    </div>
                `).join('')}`;
        }

        function openFunctionModal() {
            document.getElementById('functionModal').style.display = 'block';
            updateFunctionAssigneesList();
            clearFunctionForm();
        }

        function closeFunctionModal() {
            document.getElementById('functionModal').style.display = 'none';
        }

        function clearFunctionForm() {
            document.getElementById('functionName').value = '';
            document.getElementById('functionColor').value = '#3498db';
            document.getElementById('functionDescription').value = '';
            document.querySelectorAll('#functionAssignees input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        function updateFunctionAssigneesList() {
            document.getElementById('functionAssignees').innerHTML = users.map(user => `
                <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0.3rem 0;">
                    <input type="checkbox" value="${user.name}">
                    <span>${user.name}</span>
                </label>
            `).join('');
        }

        function saveFunction() {
            const data = {
                name: document.getElementById('functionName').value.trim(),
                color: document.getElementById('functionColor').value,
                description: document.getElementById('functionDescription').value.trim(),
                assignees: Array.from(document.querySelectorAll('#functionAssignees input[type="checkbox"]:checked')).map(cb => cb.value)
            };

            if (!data.name) {
                alert('–í–≤–µ–¥—ñ—Ç—å –Ω–∞–∑–≤—É —Ñ—É–Ω–∫—Ü—ñ—ó');
                return;
            }

            functions.push({id: Date.now(), ...data});
            saveData();
            updateSelects();
            renderFunctions();
            closeFunctionModal();
            alert('–§—É–Ω–∫—Ü—ñ—é —Å—Ç–≤–æ—Ä–µ–Ω–æ');
        }

        function deleteFunction(functionId) {
            if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é?')) {
                functions = functions.filter(f => f.id !== functionId);
                saveData();
                updateSelects();
                renderFunctions();
                alert('–§—É–Ω–∫—Ü—ñ—é –≤–∏–¥–∞–ª–µ–Ω–æ');
            }
        }

        function renderFunctions() {
            const container = document.getElementById('functionsContainer');
            if (functions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>–§—É–Ω–∫—Ü—ñ—ó –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó</h3>
                        <p>–î–æ–¥–∞–π—Ç–µ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä—É–≤–∞–Ω–Ω—è —Ä–æ–±–æ—Ç–∏</p>
                    </div>`;
                return;
            }

            container.innerHTML = `
                <div class="function-cards">
                    ${functions.map(func => `
                        <div class="function-card">
                            <div class="function-title" style="color: ${func.color};">${func.name}</div>
                            <div class="function-description">${func.description}</div>
                            <div class="function-assignees">
                                ${func.assignees.map(a => `<span class="assignee-badge">${a}</span>`).join('')}
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                                <span class="function-tasks-count">–ó–∞–≤–¥–∞–Ω—å: ${tasks.filter(t => t.function === func.name).length}</span>
                                <button class="btn btn-small btn-danger" onclick="deleteFunction(${func.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }

        function openRegularTaskModal() {
            if (!hasPermission('createRegular')) {
                showPermissionError();
                return;
            }
            document.getElementById('regularTaskModal').style.display = 'block';
            clearRegularTaskForm();
            updateRegularTaskSelects();
        }

        function closeRegularTaskModal() {
            document.getElementById('regularTaskModal').style.display = 'none';
        }

        function clearRegularTaskForm() {
            document.getElementById('regularTaskTitle').value = '';
            document.getElementById('regularTaskFunction').value = '';
            document.getElementById('regularTaskAssignee').value = '';
            document.getElementById('regularTaskPeriod').value = 'weekly';
            document.getElementById('regularTaskDuration').value = '1';
            document.getElementById('regularTaskDescription').value = '';
            document.getElementById('customDaysContainer').style.display = 'none';
            document.querySelectorAll('input[name="customDays"]').forEach(cb => cb.checked = false);
        }

        function updatePeriodOptions() {
            const period = document.getElementById('regularTaskPeriod').value;
            const customDaysContainer = document.getElementById('customDaysContainer');
            
            if (period === 'custom') {
                customDaysContainer.style.display = 'block';
            } else {
                customDaysContainer.style.display = 'none';
                // –û—á–∏—Å—Ç–∏—Ç–∏ –≤–∏–±—Ä–∞–Ω—ñ –¥–Ω—ñ
                document.querySelectorAll('input[name="customDays"]').forEach(cb => cb.checked = false);
            }
        }

        function updateRegularTaskSelects() {
            document.getElementById('regularTaskFunction').innerHTML = '<option value="">–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó</option>' + 
                functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
            document.getElementById('regularTaskAssignee').innerHTML = '<option value="">–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å</option>' + 
                users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
        }

        function saveRegularTask() {
            const period = document.getElementById('regularTaskPeriod').value;
            let customDays = [];
            
            if (period === 'custom') {
                customDays = Array.from(document.querySelectorAll('input[name="customDays"]:checked')).map(cb => parseInt(cb.value));
                if (customDays.length === 0) {
                    alert('–û–±–µ—Ä—ñ—Ç—å —Ö–æ—á–∞ –± –æ–¥–∏–Ω –¥–µ–Ω—å –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è');
                    return;
                }
            }
            
            const data = {
                title: document.getElementById('regularTaskTitle').value.trim(),
                function: document.getElementById('regularTaskFunction').value,
                assignee: document.getElementById('regularTaskAssignee').value,
                period: period,
                customDays: customDays,
                duration: parseInt(document.getElementById('regularTaskDuration').value),
                description: document.getElementById('regularTaskDescription').value.trim()
            };

            if (!data.title || !data.assignee) {
                alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –Ω–∞–∑–≤—É —Ç–∞ –≤–∏–∫–æ–Ω–∞–≤—Ü—è');
                return;
            }

            regularTasks.push({
                id: Date.now(),
                createdDate: new Date().toISOString(),
                lastGenerated: null,
                active: true,
                ...data
            });
            
            saveData();
            renderRegularTasks();
            closeRegularTaskModal();
            alert('–†–µ–≥—É–ª—è—Ä–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è —Å—Ç–≤–æ—Ä–µ–Ω–æ');
        }

        function generateTaskFromRegular(regularTaskId) {
            const rt = regularTasks.find(r => r.id === regularTaskId);
            if (!rt) return;

            const now = new Date();
            const deadline = new Date(now);
            deadline.setDate(deadline.getDate() + rt.duration);

            tasks.push({
                id: Date.now(),
                title: rt.title,
                function: rt.function,
                assignee: rt.assignee,
                creator: currentUser.name,
                createdDate: now.toISOString(),
                deadline: deadline.toISOString(),
                status: 'new',
                type: 'regular',
                priority: 'medium',
                pinned: false,
                additionalInfo: rt.description,
                howToReport: '',
                result: ''
            });

            const idx = regularTasks.findIndex(r => r.id === regularTaskId);
            if (idx !== -1) regularTasks[idx].lastGenerated = now.toISOString();

            saveData();
            renderRegularTasks();
            alert(`–°—Ç–≤–æ—Ä–µ–Ω–æ: ${rt.title}`);
        }

        function deleteRegularTask(regularTaskId) {
            if (confirm('–í–∏–¥–∞–ª–∏—Ç–∏ —Ä–µ–≥—É–ª—è—Ä–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è?')) {
                regularTasks = regularTasks.filter(rt => rt.id !== regularTaskId);
                saveData();
                renderRegularTasks();
                alert('–†–µ–≥—É–ª—è—Ä–Ω–µ –∑–∞–≤–¥–∞–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–æ');
            }
        }

        function renderRegularTasks() {
            const container = document.getElementById('regularTasksContainer');
            if (regularTasks.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>–†–µ–≥—É–ª—è—Ä–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</h3>
                        <p>–î–æ–¥–∞–π—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó</p>
                    </div>`;
                return;
            }

            container.innerHTML = `
                <div class="regular-tasks-grid">
                    ${regularTasks.map(rt => {
                        let periodText = '';
                        const dayNames = ['–ù–µ–¥—ñ–ª—è', '–ü–æ–Ω–µ–¥—ñ–ª–æ–∫', '–í—ñ–≤—Ç–æ—Ä–æ–∫', '–°–µ—Ä–µ–¥–∞', '–ß–µ—Ç–≤–µ—Ä', '–ü\'—è—Ç–Ω–∏—Ü—è', '–°—É–±–æ—Ç–∞'];
                        
                        switch(rt.period) {
                            case 'daily': periodText = '—â–æ–¥–Ω—è'; break;
                            case 'weekly': periodText = '—â–æ—Ç–∏–∂–Ω—è'; break;
                            case 'monthly': periodText = '—â–æ–º—ñ—Å—è—Ü—è'; break;
                            case 'workdays': periodText = '—Ä–æ–±–æ—á—ñ –¥–Ω—ñ (–ü–Ω-–ü—Ç)'; break;
                            case 'weekends': periodText = '–≤–∏—Ö—ñ–¥–Ω—ñ (–°–±-–ù–¥)'; break;
                            case 'custom': 
                                if (rt.customDays && rt.customDays.length > 0) {
                                    const selectedDays = rt.customDays.map(d => dayNames[d]).join(', ');
                                    periodText = `–≤–∏–±—Ä–∞–Ω—ñ –¥–Ω—ñ: ${selectedDays}`;
                                } else {
                                    periodText = '–≤–∏–±—Ä–∞–Ω—ñ –¥–Ω—ñ';
                                }
                                break;
                            default: periodText = rt.period;
                        }

                        const lastGenerated = rt.lastGenerated ? new Date(rt.lastGenerated).toLocaleDateString('uk-UA') : '–ù—ñ–∫–æ–ª–∏';

                        return `
                            <div class="regular-task-card">
                                <div class="regular-task-header">
                                    <div class="regular-task-title">${rt.title}</div>
                                </div>
                                <div class="regular-task-info">
                                    <div><strong>–í–∏–∫–æ–Ω–∞–≤–µ—Ü—å:</strong> ${rt.assignee}</div>
                                    <div><strong>–§—É–Ω–∫—Ü—ñ—è:</strong> ${rt.function || '–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó'}</div>
                                    <div><strong>–ü–µ—Ä—ñ–æ–¥–∏—á–Ω—ñ—Å—Ç—å:</strong> ${periodText}</div>
                                    <div><strong>–î–Ω—ñ–≤ –Ω–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:</strong> ${rt.duration}</div>
                                    <div><strong>–û—Å—Ç–∞–Ω–Ω—î —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è:</strong> ${lastGenerated}</div>
                                    ${rt.description ? `<div><strong>–û–ø–∏—Å:</strong> ${rt.description}</div>` : ''}
                                </div>
                                <div class="regular-task-actions">
                                    <button class="btn btn-small btn-success" onclick="generateTaskFromRegular(${rt.id})">‚ö° –°—Ç–≤–æ—Ä–∏—Ç–∏</button>
                                    <button class="btn btn-small btn-danger" onclick="deleteRegularTask(${rt.id})">üóëÔ∏è</button>
                                </div>
                            </div>`;
                    }).join('')}
                </div>`;
        }

        function renderControlDashboard() {
            updateControlOverview();
            updateControlView();
        }

        function updateControlOverview() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);

            const urgent = tasks.filter(t => new Date(t.deadline) < now && t.status !== 'done').length;
            const warning = tasks.filter(t => {
                const deadline = new Date(t.deadline);
                return deadline >= today && deadline < tomorrow && t.status !== 'done';
            }).length;
            const active = tasks.filter(t => t.status === 'progress').length;
            const completed = tasks.filter(t => t.status === 'done').length;

            document.getElementById('urgentCount').textContent = urgent;
            document.getElementById('warningCount').textContent = warning;
            document.getElementById('activeCount').textContent = active;
            document.getElementById('completedCount').textContent = completed;
        }

        function updateControlView() {
            const view = document.getElementById('controlView')?.value || 'workload';
            const container = document.getElementById('controlContent');

            if (view === 'workload') {
                const assignees = [...new Set(tasks.map(t => t.assignee))].filter(Boolean);
                container.innerHTML = `<h3>–ù–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤</h3>` +
                    assignees.map(assignee => {
                        const assigneeTasks = tasks.filter(t => t.assignee === assignee);
                        const active = assigneeTasks.filter(t => t.status !== 'done');
                        const overdue = assigneeTasks.filter(t => new Date(t.deadline) < new Date() && t.status !== 'done');

                        return `
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <strong>${assignee}</strong>
                                    <div>
                                        –í—Å—å–æ–≥–æ: ${assigneeTasks.length} | 
                                        –ê–∫—Ç–∏–≤–Ω–∏—Ö: ${active.length}
                                        ${overdue.length > 0 ? ` | <span style="color: #e74c3c;">–ü—Ä–æ—Å—Ç—Ä–æ—á–µ–Ω–æ: ${overdue.length}</span>` : ''}
                                    </div>
                                </div>
                            </div>`;
                    }).join('');
            }
        }

        function renderAnalytics() {
            const total = tasks.length;
            const completed = tasks.filter(t => t.status === 'done').length;
            const overdue = tasks.filter(t => new Date(t.deadline) < new Date() && t.status !== 'done').length;
            const efficiency = total > 0 ? Math.round((completed / total) * 100) : 0;

            document.getElementById('totalTasksCount').textContent = total;
            document.getElementById('completedTasksCount').textContent = completed;
            document.getElementById('overdueTasksCount').textContent = overdue;
            document.getElementById('efficiencyPercent').textContent = efficiency + '%';

            renderStatusChart();
            renderWorkloadChart();
        }

        function renderStatusChart() {
            const counts = {
                new: tasks.filter(t => t.status === 'new').length,
                progress: tasks.filter(t => t.status === 'progress').length,
                review: tasks.filter(t => t.status === 'review').length,
                done: tasks.filter(t => t.status === 'done').length
            };
            const total = Object.values(counts).reduce((a, b) => a + b, 0);
            
            document.getElementById('statusChart').innerHTML = Object.entries(counts).map(([status, count]) => {
                const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
                const colors = {new: '#3498db', progress: '#f39c12', review: '#e91e63', done: '#27ae60'};
                
                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 12px; height: 12px; background: ${colors[status]}; border-radius: 2px;"></div>
                            <span style="font-size: 0.85rem;">${getStatusText(status)}</span>
                        </div>
                        <div style="flex: 1; margin: 0 1rem;">
                            <div style="background: #ecf0f1; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="width: ${percentage}%; height: 100%; background: ${colors[status]}; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        <span style="font-weight: 600; font-size: 0.8rem; min-width: 40px;">${count} (${percentage}%)</span>
                    </div>`;
            }).join('');
        }

        function renderWorkloadChart() {
            const assignees = [...new Set(tasks.map(t => t.assignee))].filter(Boolean);
            const maxTasks = Math.max(...assignees.map(a => tasks.filter(t => t.assignee === a).length), 1);
            
            document.getElementById('workloadChart').innerHTML = assignees.map(assignee => {
                const assigneeTasks = tasks.filter(t => t.assignee === assignee);
                const active = assigneeTasks.filter(t => t.status !== 'done');
                const percentage = Math.round((assigneeTasks.length / maxTasks) * 100);
                
                return `
                    <div style="margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="font-weight: 600; font-size: 0.85rem;">${assignee}</span>
                            <span style="font-size: 0.8rem;">${assigneeTasks.length} (${active.length} –∞–∫—Ç–∏–≤–Ω–∏—Ö)</span>
                        </div>
                        <div style="background: #ecf0f1; height: 8px; border-radius: 4px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: #3498db; transition: width 0.3s;"></div>
                        </div>
                    </div>`;
            }).join('');
        }

        // –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º–∏
        function openUserModal(userId = null) {
            if (!hasPermission('manageUsers')) {
                showPermissionError();
                return;
            }
            document.getElementById('userModal').style.display = 'block';
            if (userId) {
                editingUserId = userId;
                fillUserForm(userId);
                document.getElementById('userModalTitle').textContent = '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞';
            } else {
                editingUserId = null;
                clearUserForm();
                document.getElementById('userModalTitle').textContent = '–î–æ–¥–∞—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞';
            }
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
            editingUserId = null;
        }

        function clearUserForm() {
            ['userName', 'userEmail', 'userPhone', 'userPosition', 'userDepartment', 'userNotes'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('userRole').value = 'employee';
        }

        function fillUserForm(userId) {
            const user = users.find(u => u.id === userId);
            if (user) {
                document.getElementById('userName').value = user.name;
                document.getElementById('userEmail').value = user.email || '';
                document.getElementById('userPhone').value = user.phone || '';
                document.getElementById('userRole').value = user.role;
                document.getElementById('userPosition').value = user.position || '';
                document.getElementById('userDepartment').value = user.department || '';
                document.getElementById('userNotes').value = user.notes || '';
            }
        }

        function saveUser() {
            const data = {
                name: document.getElementById('userName').value.trim(),
                email: document.getElementById('userEmail').value.trim(),
                phone: document.getElementById('userPhone').value.trim(),
                role: document.getElementById('userRole').value,
                position: document.getElementById('userPosition').value.trim(),
                department: document.getElementById('userDepartment').value.trim(),
                notes: document.getElementById('userNotes').value.trim()
            };

            if (!data.name || !data.email) {
                alert('–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —ñ–º\'—è —Ç–∞ email');
                return;
            }

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —É–Ω—ñ–∫–∞–ª—å–Ω–æ—Å—Ç—ñ email
            const existingUser = users.find(u => u.email === data.email && (!editingUserId || u.id !== editingUserId));
            if (existingUser) {
                alert('–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —Ç–∞–∫–∏–º email –≤–∂–µ —ñ—Å–Ω—É—î');
                return;
            }

            if (editingUserId) {
                const idx = users.findIndex(u => u.id === editingUserId);
                if (idx !== -1) {
                    const oldName = users[idx].name;
                    users[idx] = {...users[idx], ...data};
                    
                    // –û–Ω–æ–≤–∏—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è —è–∫—â–æ –∑–º—ñ–Ω–∏–ª–æ—Å—è —ñ–º'—è
                    if (oldName !== data.name) {
                        tasks.forEach(task => {
                            if (task.assignee === oldName) task.assignee = data.name;
                            if (task.creator === oldName) task.creator = data.name;
                        });
                        
                        functions.forEach(func => {
                            func.assignees = func.assignees.map(a => a === oldName ? data.name : a);
                        });
                        
                        regularTasks.forEach(rt => {
                            if (rt.assignee === oldName) rt.assignee = data.name;
                        });
                    }
                }
                alert('–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–æ');
            } else {
                const newUser = {
                    id: Math.max(...users.map(u => u.id || 0), 0) + 1,
                    ...data
                };
                users.push(newUser);
                alert('–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ —Å—Ç–≤–æ—Ä–µ–Ω–æ');
            }

            saveData();
            updateSelects();
            renderUsers();
            closeUserModal();
        }

        function deleteUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–∏ —î –∑–∞–≤–¥–∞–Ω–Ω—è –ø—Ä–∏–∑–Ω–∞—á–µ–Ω—ñ —Ü—å–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
            const userTasks = tasks.filter(t => t.assignee === user.name || t.creator === user.name);
            if (userTasks.length > 0) {
                if (!confirm(`–£ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ ${user.name} —î ${userTasks.length} –∑–∞–≤–¥–∞–Ω—å. –í–∏–¥–∞–ª–∏—Ç–∏ –≤—Å–µ –æ–¥–Ω–æ?`)) {
                    return;
                }
            }

            if (confirm(`–í–∏–¥–∞–ª–∏—Ç–∏ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ ${user.name}?`)) {
                users = users.filter(u => u.id !== userId);
                
                // –í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∑ —Ñ—É–Ω–∫—Ü—ñ–π
                functions.forEach(func => {
                    func.assignees = func.assignees.filter(a => a !== user.name);
                });

                saveData();
                updateSelects();
                renderUsers();
                renderTasks();
                alert('–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–æ');
            }
        }

        function renderUsers() {
            const container = document.getElementById('usersContainer');
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫–∏</h3>
                        <p>–î–æ–¥–∞–π—Ç–µ —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤ –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–æ–º–∞–Ω–¥–æ—é</p>
                    </div>`;
                return;
            }

            container.innerHTML = `
                <div class="function-cards">
                    ${users.map(user => {
                        const roleText = {owner: '–í–ª–∞—Å–Ω–∏–∫', manager: '–ú–µ–Ω–µ–¥–∂–µ—Ä', employee: '–°–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫'}[user.role];
                        const roleColor = {owner: '#e74c3c', manager: '#f39c12', employee: '#3498db'}[user.role];
                        const userTasks = tasks.filter(t => t.assignee === user.name);
                        const activeTasks = userTasks.filter(t => t.status !== 'done');
                        
                        return `
                            <div class="function-card">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                    <div class="function-title">${user.name}</div>
                                    <span style="background: ${roleColor}; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">${roleText}</span>
                                </div>
                                
                                <div style="margin-bottom: 1rem; font-size: 0.85rem; line-height: 1.4;">
                                    ${user.position ? `<div><strong>–ü–æ—Å–∞–¥–∞:</strong> ${user.position}</div>` : ''}
                                    ${user.department ? `<div><strong>–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:</strong> ${user.department}</div>` : ''}
                                    <div><strong>Email:</strong> ${user.email}</div>
                                    ${user.phone ? `<div><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${user.phone}</div>` : ''}
                                    ${user.notes ? `<div style="margin-top: 0.5rem;"><strong>–ü—Ä–∏–º—ñ—Ç–∫–∏:</strong> ${user.notes}</div>` : ''}
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <div style="font-size: 0.85rem;">
                                        <div>–ó–∞–≤–¥–∞–Ω—å: <strong>${userTasks.length}</strong></div>
                                        <div>–ê–∫—Ç–∏–≤–Ω–∏—Ö: <strong style="color: ${activeTasks.length > 0 ? '#f39c12' : '#27ae60'};">${activeTasks.length}</strong></div>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                                    <button class="btn btn-small" onclick="openUserModal(${user.id})">‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞—Ç–∏</button>
                                    ${user.role !== 'owner' ? `<button class="btn btn-small btn-danger" onclick="deleteUser(${user.id})">üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏</button>` : ''}
                                </div>
                            </div>`;
                    }).join('')}
                </div>`;
        }

        function updateSelects() {
            const taskFunc = document.getElementById('taskFunction');
            const funcFilter = document.getElementById('functionFilter');
            const taskAssignee = document.getElementById('taskAssignee');
            const assigneeFilter = document.getElementById('assigneeFilter');

            [taskFunc, funcFilter].forEach(el => {
                if (el) {
                    const current = el.value;
                    el.innerHTML = (el.id.includes('taskFunction') ? '<option value="">–ë–µ–∑ —Ñ—É–Ω–∫—Ü—ñ—ó</option>' : '<option value="">–§—É–Ω–∫—Ü—ñ—ó</option>') +
                        functions.map(f => `<option value="${f.name}">${f.name}</option>`).join('');
                    el.value = current;
                }
            });

            [taskAssignee, assigneeFilter].forEach(el => {
                if (el) {
                    const current = el.value;
                    el.innerHTML = (el.id.includes('taskAssignee') ? '<option value="">–û–±–µ—Ä—ñ—Ç—å –≤–∏–∫–æ–Ω–∞–≤—Ü—è</option>' : '<option value="">–í–∏–∫–æ–Ω–∞–≤—Ü—ñ</option>') +
                        users.map(u => `<option value="${u.name}">${u.name}</option>`).join('');
                    el.value = current;
                }
            });
        }

        function formatDateTime(dateTimeString) {
            const date = new Date(dateTimeString);
            const now = new Date();
            const isOverdue = date < now;
            const formatted = date.toLocaleString('uk-UA', {
                year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });
            return isOverdue ? `<span style="color: #e74c3c; font-weight: 600;">${formatted}</span>` : formatted;
        }

        function getStatusText(status) {
            return {new: '–ù–æ–≤–µ', progress: '–í —Ä–æ–±–æ—Ç—ñ', review: '–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞', done: '–ì–æ—Ç–æ–≤–æ'}[status] || status;
        }

        function getTypeText(type) {
            return {single: '–†–∞–∑–æ–≤–µ', regular: '–†–µ–≥—É–ª—è—Ä–Ω–µ', bottleneck: '–í—É–∑—å–∫–µ –º—ñ—Å—Ü–µ'}[type] || type;
        }

        function exportToCSV() {
            const data = tasks.map(task => ({
                '–ó–∞–≤–¥–∞–Ω–Ω—è': task.title,
                '–í—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–π': task.assignee,
                '–°—Ç–≤–æ—Ä–∏–≤': task.creator,
                '–î–µ–¥–ª–∞–π–Ω': formatDateTime(task.deadline).replace(/<[^>]*>/g, ''),
                '–°—Ç–∞—Ç—É—Å': getStatusText(task.status),
                '–¢–∏–ø': getTypeText(task.type),
                '–ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç': task.priority || 'medium',
                '–§—É–Ω–∫—Ü—ñ—è': task.function || '',
                '–î–æ–¥–∞—Ç–∫–æ–≤–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è': task.additionalInfo || '',
                '–Ø–∫ –∑–≤—ñ—Ç—É–≤–∞—Ç–∏—Å—è': task.howToReport || '',
                '–†–µ–∑—É–ª—å—Ç–∞—Ç': task.result || ''
            }));

            const csv = [
                Object.keys(data[0]).join(','),
                ...data.map(row => Object.values(row).map(val => `"${val}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `tasks_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function setLanguage(lang) {
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        window.onclick = function(event) {
            ['taskModal', 'functionModal', 'regularTaskModal', 'userModal', 'inviteModal', 'inviteLinkModal'].forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                    if (modalId === 'taskModal') editingTaskId = null;
                    if (modalId === 'userModal') editingUserId = null;
                }
            });
        }
    </script>
</body>
</html>
